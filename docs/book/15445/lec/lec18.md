# Lec19 多版本并发控制

给数据增加历史版本。

几乎所有的关系型数据库都支持 MVCC 。

并发控制，版本管理，垃圾回收，索引管理，删除。

## 1. 并发控制

1. 时间戳。
2. OCC 。
3. 两阶段锁。

## 2. 版本控制

链表来记录版本。

简单追加：在数据的表中简单追加一行记录。头插和尾插两种方式。

![20220324222312](https://cdn.jsdelivr.net/gh/weijiew/pic/images/20220324222312.png)

时间旅行存储：将历史版本单独放到一个表中。

![20220324222442](https://cdn.jsdelivr.net/gh/weijiew/pic/images/20220324222442.png)

简单增量：增量存储。没有存历史数据，而是存历史数据的增量。

![20220324222705](https://cdn.jsdelivr.net/gh/weijiew/pic/images/20220324222705.png)

## 3. 垃圾回收

回收历史版本。

行记录级别的垃圾清理：后台有个线程单独的进行清理。一个优化策略：扫描的时候扫描被更新过的页。

事务级别的垃圾清理：以事务为单位清理和事物相关的所有版本。

## 4. 索引

辅助索引，逻辑地址，物理地址。

https://www.bilibili.com/video/BV1Ja411z7mc/?spm_id_from=pageDriver